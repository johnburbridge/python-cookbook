#!/bin/bash

# Exit on error
set -e

# Get the root directory of the repository
ROOT_DIR=$(git rev-parse --show-toplevel)

# Get the list of changed files between current branch and origin/main
CHANGED_FILES=$(git diff --name-only origin/main...HEAD)

# Get unique recipe directories that have changes
RECIPES_TO_TEST=$(echo "$CHANGED_FILES" | grep -oE '^[^/]+/' | sort -u | sed 's/\///g' || true)

if [ -z "$RECIPES_TO_TEST" ]; then
    echo "No recipe changes detected."
    exit 0
fi

# Activate root virtual environment for task
. "$ROOT_DIR/venv/bin/activate"

# Run tests for each changed recipe
for recipe in $RECIPES_TO_TEST; do
    if [ -d "$ROOT_DIR/$recipe" ] && [ -f "$ROOT_DIR/$recipe/requirements.txt" ]; then
        echo "Testing recipe: $recipe"
        task test RECIPE="$recipe"
    fi
done

# Deactivate virtual environment
deactivate

echo "All tests passed! ðŸš€" 